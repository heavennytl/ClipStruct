# ClipStruct 测试指南

## 当前完成功能

### ✅ 阶段一：项目初始化（100%）
- 项目结构搭建完成
- 所有配置文件就绪
- 构建系统正常运行

### ✅ 阶段二：字幕获取与预处理（95%）
- 三层回退字幕获取策略
- 文本预处理（合并、过滤、分段）
- YouTube SPA 导航支持
- UI 状态管理与错误处理

### ✅ 阶段三：规则引擎结构分析（95%）
- 7种结构类型自动识别（hook / background / corePoint / example / transition / emotional / callToAction）
- 智能意图描述生成
- 后处理优化（避免同类型连续、确保必要类型存在）
- 结构统计与可视化展示

### ✅ 阶段四：UI面板与时间轴可视化（90%）
- 水平时间轴可视化（按颜色编码）
- 视频播放同步（当前段实时高亮）
- 点击段落跳转视频
- 列表自动滚动跟随播放
- 统计面板可折叠优化

### ✅ 阶段五：手动编辑与导出（100%）
- 编辑模态框（修改类型、意图、时间边界）
- 表单验证（时间格式、范围、内容长度）
- 快捷键（Ctrl+Enter 保存，Esc 取消）
- 用户修改标记（绿色边框 + 勾选图标）
- 本地持久化（自动保存、自动加载）
- Markdown/纯文本导出

### ✅ 阶段六：Popup 设置页面（95%）
- 标签切换（设置 / 历史 / 关于）
- 基础设置（自动分析开关）
- AI 设置（启用开关、API Key、模型、端点）
- 历史记录列表（最近10条，可跳转）
- 清除历史功能
- 关于页面（版本、功能、帮助）

## 本地测试步骤

### 1. 构建扩展

```bash
cd d:\ClipStruct\clipstruct
npm run build
```

构建产物将输出到 `dist` 目录。

### 2. 加载到 Chrome

1. 打开 Chrome 浏览器
2. 访问 `chrome://extensions`
3. 开启右上角「开发者模式」
4. 点击「加载已解压的扩展程序」
5. 选择 `d:\ClipStruct\clipstruct\dist` 目录

### 3. 测试字幕获取

1. 访问任意带字幕的 YouTube 视频，例如：
   - https://www.youtube.com/watch?v=dQw4w9WgXcQ（经典示例）
   - 任何你喜欢的有字幕的视频

2. 等待页面加载完成后，右侧应出现 **ClipStruct** 面板

3. 观察面板状态变化：
   - ✅ 正常流程：`🔍 检查字幕` → `📥 获取字幕` → `⚙️ 预处理` → `✅ 完成`
   - ❌ 无字幕视频：显示错误提示「该视频未提供字幕」

4. 查看结构分析结果：
   
   **时间轴可视化**：
   - 水平时间轴（按结构类型颜色编码）
   - 段落宽度按实际时长比例显示
   - 悬停显示详细信息（类型、时间、意图）
   - 播放时当前段高亮（深色 + 放大）
   
   **预处理统计**（可折叠）：
   - 原始字幕数量
   - 预处理后数量
   - 自然分段数
   
   **结构统计**（可折叠）：
   - 总段落数和总时长
   - 每种结构类型的数量和占比
   - 彩色类型徽章（7种颜色）
   
   **结构详情列表**：
   - 每个段落的结构类型、时间范围、意图描述
   - 文本预览（前80字符）
   - 播放时当前段高亮（蓝色边框 + 浅蓝背景）
   - 自动滚动到当前播放段

5. 测试交互功能：
   - 点击时间轴段落，视频应跳转到对应位置
   - 点击列表段落，视频应跳转到对应位置
   - 播放视频时，时间轴和列表的当前段应同步高亮
   - 列表应自动滚动保持当前段可见

6. 测试编辑功能：
   - 悬停段落右上角，显示编辑按钮（✏️）
   - 点击编辑按钮，打开编辑模态框
   - 修改结构类型（下拉选择）
   - 修改意图描述（文本框，限制200字符）
   - 修改时间边界（mm:ss 格式）
   - 点击保存或按 Ctrl+Enter 保存
   - 保存后段落显示绿色左边框和勾选图标
   - 点击取消或按 Esc 关闭模态框

7. 测试导出功能：
   - 点击工具栏"📄 导出 MD"按钮
   - 下载 Markdown 文件（文件名：ClipStruct_{标题}_{日期}.md）
   - 打开文件查看内容完整性
   - 点击工具栏"📝 导出 TXT"按钮
   - 下载纯文本文件（文件名：ClipStruct_{标题}_{日期}.txt）

8. 测试持久化功能：
   - 分析一个视频，等待"自动保存"完成
   - 刷新页面，应显示"已加载保存的分析结果"提示
   - 编辑一个段落，保存后显示"修改已保存"提示
   - 切换到其他视频，再切换回来，应加载保存的结构

9. 测试 Popup 设置：
   - 点击扩展图标打开 Popup
   - 切换"⚙️ 设置" / "📋 历史" / "ℹ️ 关于"三个标签
   - 修改自动分析开关，点击保存，观察提示
   - 开启 AI 功能，配置 API Key、模型、端点
   - 点击"📋 历史"标签，查看历史记录列表
   - 点击历史记录项，应在新标签打开对应视频
   - 点击"🗑️ 清除历史"，确认后历史清空
   - 点击"ℹ️ 关于"标签，查看版本和帮助信息

### 4. 测试 SPA 导航

1. 在当前视频页面，点击推荐视频跳转
2. 面板应自动检测到视频切换并重新分析

### 5. 调试与查看日志

按 `F12` 打开 Chrome 开发者工具，切换到 Console 标签，可以看到：

- `[ClipStruct] 检测到视频切换`
- `[ClipStruct] 尝试 Innertube API 获取字幕...`
- `[ClipStruct] Innertube API 成功，获取 XXX 条字幕`
- `[ClipStruct] 开始预处理 XXX 条字幕...`
- `[ClipStruct] 开始结构分析，共 X 个分段...`
- `[ClipStruct] 段落 1: hook (0.0s-15.2s)`
- `[ClipStruct] 段落 2: background (15.2s-45.8s)`
- ...
- `[ClipStruct] 结构分析完成`

## 测试场景

### ✅ 场景 1：标准结构视频（推荐测试）
**特征**：有明显的开场吸引、背景说明、核心内容、案例、结尾CTA  
**推荐视频**：教程类、知识分享类视频  
**预期结果**：
- 能识别出5种以上结构类型
- hook 在开头，callToAction 在结尾
- 结构分布合理

### ✅ 场景 2：有字幕的英文视频
- 预期：成功获取并分析结构
- 语言优先级：英文
- 关键词匹配：英文关键词生效

### ✅ 场景 3：有字幕的中文视频
- 预期：成功获取并分析结构
- 语言优先级：中文优先
- 关键词匹配：中文关键词生效

### ✅ 场景 4：无字幕视频
- 预期：显示错误提示「该视频未提供字幕，无法分析结构」

### ✅ 场景 5：YouTube 站内跳转
- 预期：自动检测视频切换，重新分析新视频
- 面板状态自动重置

### ✅ 场景 6：短视频（< 5分钟）
**特征**：快速开场、直接进入核心内容、简短CTA  
**预期结果**：
- hook + corePoint + callToAction 为主
- 段落数较少（3-5段）

### ✅ 场景 7：长视频（> 30分钟）
**特征**：多个核心观点、多个案例、多次转折  
**预期结果**：
- corePoint 和 example 占比高
- transition 出现多次
- 段落数较多（10+段）

### ⚠️ 场景 8：时间轴交互测试
**测试点**：
- 点击时间轴不同段落，视频是否正确跳转
- 播放时当前段高亮是否实时更新
- 悬停时是否显示完整信息
- 列表是否自动滚动到当前段

### ⚠️ 场景 9：编辑功能测试
**测试点**：
- 修改结构类型，保存后类型是否正确更新
- 修改意图描述，保存后描述是否正确更新
- 调整时间边界，保存后时间是否正确更新
- 用户修改标记是否显示（绿色边框 + 勾选图标）

### ⚠️ 场景 10：表单验证测试
**测试点**：
- 输入无效时间格式（如 "abc"），应显示错误提示
- 开始时间大于结束时间，应显示错误提示
- 意图描述为空，应显示错误提示
- 意图描述超过200字符，应显示错误提示

### ⚠️ 场景 11：导出功能测试
**测试点**：
- Markdown 导出内容完整（标题、URL、时间轴、概览、详情）
- 纯文本导出内容完整
- 文件名正确生成（清理非法字符）
- 下载成功提示显示

### ⚠️ 场景 12：持久化测试
**测试点**：
- 分析后自动保存
- 刷新页面后自动加载
- 编辑后立即保存
- 切换视频后再回来，加载保存的结构

### ⚠️ 场景 13：Popup 设置测试
**测试点**：
- 标签切换是否流畅
- 设置保存后刷新 Popup，设置是否保持
- 历史记录是否按时间倒序显示
- 清除历史是否有确认提示
- 点击历史项是否正确跳转

### ⚠️ 场景 14：AI 设置测试
**测试点**：
- 开启 AI 开关后，AI 配置是否显示
- 关闭 AI 开关后，AI 配置是否隐藏
- API Key 输入框是否为密码类型
- 保存 AI 设置后是否持久化

### ⚠️ 场景 15：性能测试
- 测试视频长度：30分钟、1小时
- 观察：分析时间、内存占用、页面流畅度
- 时间轴渲染是否流畅
- 播放同步是否有延迟
- 保存/加载速度

## 已知限制

### 字幕获取
1. **仅支持 JSON3 格式字幕**：XML 格式字幕解析待后续补充
2. **DOM 抓取方式未充分测试**：优先使用 Innertube API 和 ytplayer API

### 结构分析
1. **规则引擎的局限性**：
   - 过度依赖关键词，语言风格特殊的视频可能识别不准
   - 固定时间阈值不灵活（15秒、30秒、45秒）
   - 无法理解复杂语义关系
   
2. **意图描述的通用性**：
   - 当前意图描述偏向模板化
   - 增强描述仅覆盖部分常见关键词

3. **边界情况**：
   - 无明显结构的视频可能所有段落都识别为 corePoint
   - 多语言混合视频关键词匹配不准确
   - 非标准结构视频（纯聊天、纯展示）识别效果不佳

### 时间轴与交互
1. **极短段落（< 2秒）**：时间轴上可能难以点击
2. **超长视频（> 2小时）**：时间轴密度过高，标签可能重叠
3. **大量段落（> 50段）**：列表滚动可能有轻微卡顿
4. **面板宽度拖拽**：未实现（可后续补充）
5. **深色主题适配**：未实现（可后续补充）

### 编辑与导出
1. **拖拽调整边界**：未实现，仅支持输入时间（可后续补充）
2. **批量编辑**：未实现，一次只能编辑一个段落（可后续补充）
3. **撤销/重做**：未实现编辑历史功能（可后续补充）
4. **导出格式**：文本预览截断为200字符
5. **存储配额**：chrome.storage.local 有 5MB 限制

### 性能
1. **超长视频处理**：可能需要分块处理（待优化）
2. **单元测试未实现**：待阶段八补充

## 下一步开发

### 🎯 阶段七：AI 辅助标注（可选）

接入 AI 模型提升结构分析准确度：
- AI API 调用模块（OpenAI Chat Completions）
- 集成到分析流程（读取设置、调用 AI）
- AI 分析失败时回退到规则引擎
- 显示 AI 分析状态

### 🎯 阶段八：测试、优化与发布

全面测试、性能优化、准备发布：
- 功能测试（所有场景验收）
- 性能优化（内存、加载时间）
- 兼容性测试（Chrome 不同版本）
- 准备发布材料（截图、描述、隐私政策）

## 反馈与建议

如有问题或建议，请在项目中记录：
- 代码问题 → 控制台日志 + 错误信息
- 功能建议 → 记录到开发计划
- 性能问题 → 记录视频长度和卡顿情况
