# ClipStruct 开发计划

## 项目概述

ClipStruct 是一款 YouTube 视频结构拉片 Chrome 插件，帮助创作者在观看视频时清晰理解视频结构与内容意图。

**技术栈**：React 19 + Vite + Chrome Extension Manifest V3

**产品文档**：参见 `PRD.md`

---

## 阶段一：项目初始化与基础架构

**目标**：搭建开发环境，完成项目骨架，确保扩展能在 Chrome 中正常加载。

### 1.1 环境搭建

- [x] 初始化 npm 项目：`npm init -y`
- [x] 安装生产依赖：`npm install react react-dom`
- [x] 安装开发依赖：`npm install -D vite @vitejs/plugin-react jest`
- [x] 配置 `vite.config.js`（多入口构建：content / background / popup）
- [x] 配置 `.gitignore`

### 1.2 项目目录结构

```
clipstruct/
├── src/
│   ├── content/          # Content Script
│   │   ├── content.jsx   # 主组件
│   │   └── content.css   # 面板样式
│   ├── background/       # Background Script
│   │   └── background.js # Service Worker
│   ├── popup/            # Popup Page
│   │   ├── popup.html
│   │   ├── popup.jsx
│   │   └── popup.css
│   └── common/           # 共享模块
│       ├── constants.js  # 枚举常量、颜色映射、关键词
│       └── utils.js      # 工具函数
├── public/
│   ├── icons/            # 插件图标
│   └── manifest.json
├── __tests__/            # 单元测试
├── package.json
└── vite.config.js
```

### 1.3 基础配置文件

- [x] 创建 `public/manifest.json`（Manifest V3，详见 PRD 第 6.1 节）
- [x] 配置 `package.json` scripts（dev / build / test）
- [x] 创建插件图标占位文件（16 / 32 / 48 / 128px）
- [x] 创建各入口文件骨架（content.jsx / background.js / popup.jsx）

### 1.4 共享模块

- [x] `constants.js`：定义结构类型枚举、颜色映射、关键词列表、填充词列表
- [x] `utils.js`：实现时间格式化（秒 → mm:ss）、数据校验等工具函数

### 验收标准

- `npm run build` 构建成功，输出 `dist` 目录
- 在 Chrome 扩展管理页加载 `dist`，扩展图标正常显示
- 打开 YouTube 页面，Content Script 能注入（控制台无报错）
- Popup 页面能正常弹出

---

## 阶段二：字幕获取与文本预处理

**目标**：实现完整的字幕获取管线，为结构分析提供干净的输入数据。

### 2.1 字幕获取（高优先级）

- [x] 实现 Innertube API 字幕获取（从 `ytInitialPlayerResponse` 解析 `captionTracks`）
- [x] 实现 ytplayer API 备选方案（从 `ytplayer.config.args` 提取字幕信息）
- [x] 实现 DOM 实时抓取兜底方案（监听字幕 DOM 节点变化）
- [x] 实现语言优先级选择逻辑（中文 → 英文 → 第一个可用）
- [x] 实现三层回退逻辑（上层失败自动降级到下层）
- [x] 错误处理：无字幕提示、加载失败提示
- [x] 支持 JSON3 格式字幕解析（XML格式暂未实现，可后续补充）

### 2.2 文本预处理（高优先级）

- [x] 实现短句合并逻辑（时间间隔 < 0.5s 且合并后 < 200 字符）
- [x] 实现自然分段检测（时间间隔 ≥ 5s 为分段点）
- [x] 实现填充词过滤（仅过滤口语填充词，保留结构信号词）
- [x] 保留时间轴映射关系（`original_indices`）
- [ ] 单元测试：合并逻辑、填充词过滤、边界情况（待后续补充）

### 2.3 YouTube SPA 导航支持

- [x] 监听 `yt-navigate-finish` 事件，检测页面切换
- [x] 视频 ID 变化时自动重新获取字幕
- [x] 使用 `useRef` 追踪上次视频 ID，避免闭包问题

### 验收标准

- 打开有字幕的 YouTube 视频，能成功获取字幕数据
- 打开无字幕视频，显示友好的提示信息
- 字幕数据格式正确（包含 text / start / duration）
- 预处理后的文本无口语填充词，短句已合并
- YouTube 站内切换视频时，能自动重新获取字幕

---

## 阶段三：规则引擎结构分析

**目标**：基于规则引擎将字幕分段为带有结构类型的段落。

### 3.1 规则引擎实现（高优先级）

- [x] 实现 7 种结构类型的识别规则（详见 PRD 第 4.4 节）：
  - hook：前 15-30 秒 + 关键词匹配
  - background：Hook 之后 + 关键词匹配
  - corePoint：长度 > 45 秒 + 关键词匹配
  - example：Core Point 之后 + 关键词匹配
  - transition：长度 < 20 秒 + 关键词匹配
  - emotional：关键词 + 感叹号/问号结尾
  - callToAction：最后 30-60 秒 + 关键词匹配
- [x] 实现段落意图描述生成（从文本中提取关键信息，生成一句话意图）
- [x] 处理无法识别的段落（默认标记为 corePoint 或 background）
- [x] 实现后处理优化（避免同类型连续、确保必要类型存在）
- [ ] 单元测试：各类型识别准确性、边界情况（待后续补充）

### 3.2 关键词管理

- [x] 将所有关键词集中到 `constants.js`，便于维护和扩展（阶段一已完成）
- [x] 支持中英文关键词（阶段一已完成）

### 3.3 分析状态管理

- [x] 实现分析阶段状态机：`idle` → `checking` → `fetching` → `analyzing` → `done`（阶段二已完成）
- [x] 各阶段 UI 反馈（加载动画、进度提示）（阶段二已完成）
- [x] 错误状态处理与展示（阶段二已完成）

### 验收标准

- 任意有字幕的视频能生成结构分段
- 每个结构段包含 type / start / end / intent 四个字段
- 分析时间 < 10 秒
- 结构类型覆盖率 > 80%（大部分段落能被正确识别）

---

## 阶段四：UI 面板与时间轴可视化

**目标**：实现右侧结构分析面板，展示时间轴、段落信息，支持视频同步。

### 4.1 右侧面板（高优先级）

- [x] 面板容器：固定在视频右侧，默认宽度 300px（阶段一已完成）
- [x] 面板头部：标题、折叠/展开按钮、分析状态指示（阶段二已完成）
- [ ] 面板可拖拽调整宽度（最小 240px，最大 500px）（暂未实现，可后续补充）
- [x] 面板可折叠/展开（阶段二已完成）
- [x] 不影响 YouTube 原始页面布局（阶段一已完成）

### 4.2 结构时间轴（高优先级）

- [x] 水平时间轴，按结构类型颜色编码
- [x] 每个结构段显示类型标签（宽度足够时显示）
- [x] 鼠标悬停显示详细信息（时间范围、类型、意图）
- [x] 点击某段跳转到对应视频时间点
- [x] 时间刻度显示（0:00、中间点、总时长）

### 4.3 段落列表

- [x] 垂直列表展示所有结构段
- [x] 每段显示：时间范围、结构类型标签（带颜色）、意图描述
- [x] 当前播放段高亮（边框加粗 + 背景色加深）
- [x] 点击段落跳转到视频对应位置
- [x] 列表可滚动（最大高度400px）
- [x] 列表标题固定在顶部

### 4.4 视频同步

- [x] 监听视频播放时间变化（`timeupdate` 事件，节流500ms）
- [x] 实时更新当前播放段高亮（时间轴 + 列表）
- [x] 列表自动滚动到当前播放段（平滑滚动）

### 4.5 样式与响应式

- [x] 使用 CSS 命名空间隔离，避免与 YouTube 样式冲突（阶段一已完成）
- [x] 面板固定宽度，不影响 YouTube 布局
- [ ] 深色/浅色适配（跟随 YouTube 主题）（可后续补充）
- [x] 统计面板可折叠（优化空间利用）

### 验收标准

- 面板在视频右侧正常显示
- 时间轴颜色与结构类型对应
- 播放视频时当前段实时高亮
- 点击结构段能跳转视频
- 面板折叠/展开流畅，不影响视频播放
- 面板不干扰 YouTube 原生交互（评论、推荐等）

---

## 阶段五：手动编辑与导出

**目标**：让用户可以修正结构分析结果，并导出为可用文档。

### 5.1 手动编辑（高优先级）

- [x] 编辑按钮（每个段落右上角）
- [x] 编辑模态框（弹窗形式）
- [x] 修改结构类型：下拉选择（7 种枚举类型）
- [x] 修改意图描述：可编辑文本框（限制 200 字）
- [x] 调整分段边界：精确时间输入（mm:ss 格式）
- [x] 保存/取消操作（Ctrl+Enter 保存，Esc 取消）
- [x] 修改后标记 `userModified: true`
- [x] 用户修改标记显示（绿色左边框 + 勾选图标）

### 5.2 本地持久化

- [x] 使用 `chrome.storage.local` 存储分析结果（通过 Background Script）
- [x] 存储键：`clipstruct_structure_{videoId}`
- [x] 打开已分析过的视频时，优先加载保存的结构
- [x] 自动保存：分析完成后自动保存，编辑后立即保存
- [x] 30 天过期自动清理（Background Script 实现）
- [x] 保存成功/失败状态提示（淡入淡出动画）

### 5.3 导出功能（中优先级）

- [x] Markdown 格式导出（视频信息 + 结构时间轴 + 结构概览 + 详细内容）
- [x] 纯文本格式导出
- [x] 下载文件命名：`ClipStruct_{视频标题}_{日期}.md` / `.txt`
- [x] 导出按钮放置在面板工具栏
- [x] 导出成功提示消息

### 验收标准

- 编辑模式下能修改结构类型和意图描述
- 修改后刷新页面，保存的结构被正确加载
- 导出的 Markdown / 纯文本格式正确，内容完整
- 30 天后旧数据被自动清理

---

## 阶段六：Background Script 与 Popup

**目标**：完成 Service Worker 消息传递和 Popup 设置页面。

### 6.1 Background Script

- [x] 消息传递接口：Content Script ↔ Background Script（阶段一已完成）
- [x] 存储管理：保存结构、加载结构、获取历史、清除历史（阶段一已完成）
- [x] 历史记录管理：最近分析的视频列表（最多 50 条）（阶段一已完成）
- [x] 预留 AI API 调用接口（跨域请求代理）（消息传递框架已支持，随时可扩展）

### 6.2 Popup Page

- [x] 插件设置界面：
  - 自动分析开关
  - AI 功能开关
  - AI API Key 配置
  - AI 模型名称配置（默认 gpt-4o-mini）
  - API 端点配置（支持兼容接口）
- [x] 分析历史列表：最近 10 条记录，点击可跳转
- [x] 清除历史按钮
- [x] 标签切换（设置 / 历史 / 关于）
- [x] 关于页面（版本信息、功能列表、使用帮助）
- [x] 保存成功/失败提示

### 6.3 设置联动

- [x] Popup 设置保存到 chrome.storage.local
- [x] Background Script 提供设置读取/保存接口
- [ ] Content Script 读取设置决定行为（是否自动分析、是否启用 AI）（待后续完善）

### 验收标准

- [x] Popup 能正常弹出，设置可保存
- [x] 历史记录正确显示、可清除
- [ ] 修改设置后 Content Script 行为相应变化（待阶段八完善）
- [ ] AI API Key 配置后，AI 分析功能可用（阶段七，可选）

---

## 阶段七：AI 辅助标注（可选增强）

**目标**：接入 AI 模型提升结构分析准确度。

### 7.1 AI 分析流程

- [ ] 调用 OpenAI Chat Completions API（或兼容接口）
- [ ] 默认模型 gpt-4o-mini，用户可在 Popup 中自定义
- [ ] 系统提示词按 PRD 第 4.4 节定义
- [ ] 输入：视频标题 + 带时间戳的字幕分段 JSON
- [ ] 输出：结构类型 + 意图描述 JSON
- [ ] 解析 AI 返回并合并到结构数据

### 7.2 容错与回退

- [ ] AI 调用失败（网络错误 / API 错误 / 格式异常）自动回退到规则引擎
- [ ] 回退时显示提示信息
- [ ] 超时控制（30 秒超时）
- [ ] Token 用量估算与提示（避免用户超额）

### 验收标准

- 配置正确 API Key 后，AI 分析结果覆盖规则引擎结果
- API Key 无效时，自动回退到规则引擎，无崩溃
- AI 返回格式异常时，能正确降级处理

---

## 阶段八：测试、优化与发布

**目标**：全面测试、性能优化、打包发布。  
**状态**：🚧 进行中（2026-02-13）  
**详细计划**：`docs/阶段八_测试发布计划.md`

### 8.1 功能测试

- [ ] 标准有字幕视频场景
- [ ] 无字幕视频场景
- [ ] 长视频场景（> 30 分钟）
- [ ] 编辑功能场景（修改 + 保存 + 刷新验证）
- [ ] 表单验证场景（错误处理）
- [ ] 导出功能场景（Markdown + 纯文本）
- [ ] Popup 设置场景（设置 + 历史 + 关于）
- [ ] SPA 导航场景（站内切换视频）

### 8.2 性能优化

- [ ] 减少不必要的 DOM 操作（React 虚拟 DOM 优化）
- [ ] 防抖/节流视频时间同步（`timeupdate` 频率过高时节流）
- [ ] 大字幕文件的分块处理
- [ ] 确保空闲内存 < 30MB，分析中 < 80MB
- [ ] 页面加载时间增加 < 300ms

### 8.3 兼容性测试

- [ ] Chrome 最新稳定版 + 前两个大版本
- [ ] YouTube 不同页面布局（默认 / 影院模式 / 全屏）
- [ ] 不同分辨率（1080p / 1440p / 4K）
- [ ] YouTube 深色/浅色主题

### 8.4 构建与发布

- [ ] `npm run build` 验证构建产物
- [ ] 确认 `dist` 目录结构与 manifest 路径一致
- [ ] 打包为 ZIP（文件名不含中文）
- [ ] 上传至 Chrome Web Store
- [ ] 填写扩展信息（名称、描述、截图、隐私政策）
- [ ] 提交审核

### 验收标准（MVP 整体）

- 所有功能测试场景通过
- 性能指标达标（详见 PRD 第 8 节）
- Chrome Web Store 审核通过

---

## 功能优先级总览

### 高优先级（MVP 核心）

| 序号 | 功能 | 所属阶段 |
|------|------|---------|
| 1 | 字幕获取（三层回退） | 阶段二 |
| 2 | 文本预处理 | 阶段二 |
| 3 | 规则引擎结构分段 | 阶段三 |
| 4 | 结构时间轴可视化 | 阶段四 |
| 5 | 视频播放同步 | 阶段四 |
| 6 | 手动编辑能力 | 阶段五 |

### 中优先级（增强功能）

| 序号 | 功能 | 所属阶段 |
|------|------|---------|
| 7 | 导出功能 | 阶段五 |
| 8 | Popup 设置与历史 | 阶段六 |
| 9 | AI 辅助标注 | 阶段七 |

### 低优先级（优化完善）

| 序号 | 功能 | 所属阶段 |
|------|------|---------|
| 10 | 深色/浅色主题适配 | 阶段四 |
| 11 | 响应式布局优化 | 阶段四 |
| 12 | 性能优化与兼容性 | 阶段八 |

---

## 注意事项

1. **依赖管理**：构建工具（vite / @vitejs/plugin-react / jest）必须装在 devDependencies
2. **样式隔离**：Content Script 样式不能污染 YouTube 页面，使用命名空间或 Shadow DOM
3. **安全性**：API Key 仅存于用户本地（`chrome.storage.local`），不上传任何服务器
4. **性能**：避免阻塞主线程，字幕解析和结构分析使用异步操作
5. **YouTube 兼容性**：YouTube 是 SPA，需监听 `yt-navigate-finish` 事件处理页面切换
6. **共享代码**：结构类型枚举、颜色映射、关键词列表等常量必须集中在 `constants.js`，避免硬编码分散在各文件
7. **代码质量**：使用 ESLint 检查代码风格，关键逻辑添加中文注释

---

## 开发命令

| 命令 | 说明 |
|------|------|
| `npm install` | 安装依赖 |
| `npm run dev` | 开发模式（监视文件变化，自动构建） |
| `npm run build` | 构建生产版本 |
| `npm test` | 运行单元测试 |

---

## 后续迭代方向（不在当前计划内）

1. 结构模板抽象（从多个视频中提取通用结构模板）
2. 相似结构视频推荐（根据结构相似性推荐视频）
3. 脚本生成（基于结构模板辅助生成视频脚本）
4. 多视频对比（并排对比多个视频的结构差异）
